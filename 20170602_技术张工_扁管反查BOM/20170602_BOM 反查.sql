declare @level int,@lastitemid int ;
select @lastitemid = 208607,@level = 0;
with recursive_cte as (
select b.FItemID as firstitemid ,cast(@level as varchar(101)) as flevel, b.FItemID as FItemID,a.FItemID as FParentID,cast(b.fqty as decimal(12,4)) as fQtyPerPro,
cast(1 as decimal(12,4))as fQty,b.funitid as funitid, cast(b.fscrap as decimal(10,4) ) as fscrap,
cast(b.fitemsize as varchar(10)) as fitemsize,--Fnumber,
b.FInterID as fbominterid,a.fbomnumber,
cast(right('000'+cast(row_number()over(order by b.finterid) as varchar(20)),3) as varchar(300)) as sn,
a.fstatus,a.fusestatus , 
cast ('.' as varchar(101)) as point
from icbom a join icbomchild b on a.finterid = b.finterid 
where b.fitemid in (select fitemid from t_icitem where fnumber in('30.16.20.10.0.0.0.00871','30.16.20.10.0.0.0.00870','30.16.20.10.0.0.0.00868','30.16.20.10.0.0.0.00866','30.16.20.10.0.0.0.00864','30.16.20.10.0.0.0.00858','30.16.20.10.0.0.0.00854','30.16.20.10.0.0.0.00848','30.16.20.10.0.0.0.00844','30.16.20.10.0.0.0.00834','30.16.20.10.0.0.0.00830','30.16.20.10.0.0.0.00820','30.16.20.10.0.0.0.00812','30.16.20.10.0.0.0.00806','30.16.20.10.0.0.0.00804','30.16.20.10.0.0.0.00798','30.16.20.10.0.0.0.00796','30.16.20.10.0.0.0.00778','30.16.20.10.0.0.0.00775','30.16.20.10.0.0.0.00764','30.16.20.10.0.0.0.00760','30.16.20.10.0.0.0.00758','30.16.20.10.0.0.0.00755','30.16.20.10.0.0.0.00754','30.16.20.10.0.0.0.00752','30.16.20.10.0.0.0.00750','30.16.20.10.0.0.0.00748','30.16.20.10.0.0.0.00746','30.16.20.10.0.0.0.00744','30.16.20.10.0.0.0.00742','30.16.20.10.0.0.0.00734','30.16.20.10.0.0.0.00733','30.16.20.10.0.0.0.00732','30.16.20.10.0.0.0.00730','30.16.20.10.0.0.0.00728','30.16.20.10.0.0.0.00726','30.16.20.10.0.0.0.00724','30.16.20.10.0.0.0.00722','30.16.20.10.0.0.0.00720','30.16.20.10.0.0.0.00718','30.16.20.10.0.0.0.00716','30.16.20.10.0.0.0.00714','30.16.20.10.0.0.0.00712','30.16.20.10.0.0.0.00710','30.16.20.10.0.0.0.00708','30.16.20.10.0.0.0.00706','30.16.20.10.0.0.0.00704','30.16.20.10.0.0.0.00702','30.16.20.10.0.0.0.00700','30.16.20.10.0.0.0.00698','30.16.20.10.0.0.0.00696','30.16.20.10.0.0.0.00695','30.16.20.10.0.0.0.00694','30.16.20.10.0.0.0.00692','30.16.20.10.0.0.0.00690','30.16.20.10.0.0.0.00688','30.16.20.10.0.0.0.00686','30.16.20.10.0.0.0.00684','30.16.20.10.0.0.0.00682','30.16.20.10.0.0.0.00680','30.16.20.10.0.0.0.00678','30.16.20.10.0.0.0.00676','30.16.20.10.0.0.0.00674','30.16.20.10.0.0.0.00672','30.16.20.10.0.0.0.00670','30.16.20.10.0.0.0.00668','30.16.20.10.0.0.0.00666','30.16.20.10.0.0.0.00664','30.16.20.10.0.0.0.00662','30.16.20.10.0.0.0.00660','30.16.20.10.0.0.0.00658','30.16.20.10.0.0.0.00656','30.16.20.10.0.0.0.00654','30.16.20.10.0.0.0.00652','30.16.20.10.0.0.0.00650','30.16.20.10.0.0.0.00648','30.16.20.10.0.0.0.00646','30.16.20.10.0.0.0.00644','30.16.20.10.0.0.0.00642','30.16.20.10.0.0.0.00640','30.16.20.10.0.0.0.00638','30.16.20.10.0.0.0.00636','30.16.20.10.0.0.0.00634','30.16.20.10.0.0.0.00632','30.16.20.10.0.0.0.00630','30.16.20.10.0.0.0.00628','30.16.20.10.0.0.0.00626','30.16.20.10.0.0.0.00624','30.16.20.10.0.0.0.00622','30.16.20.10.0.0.0.00620','30.16.20.10.0.0.0.00618','30.16.20.10.0.0.0.00616','30.16.20.10.0.0.0.00615','30.16.20.10.0.0.0.00614','30.16.20.10.0.0.0.00612','30.16.20.10.0.0.0.00610','30.16.20.10.0.0.0.00608','30.16.20.10.0.0.0.00606','30.16.20.10.0.0.0.00604','30.16.20.10.0.0.0.00602','30.16.20.10.0.0.0.00600','30.16.20.10.0.0.0.00598','30.16.20.10.0.0.0.00596','30.16.20.10.0.0.0.00594','30.16.20.10.0.0.0.00592','30.16.20.10.0.0.0.00590','30.16.20.10.0.0.0.00588','30.16.20.10.0.0.0.00586','30.16.20.10.0.0.0.00585','30.16.20.10.0.0.0.00584','30.16.20.10.0.0.0.00582','30.16.20.10.0.0.0.00580','30.16.20.10.0.0.0.00578','30.16.20.10.0.0.0.00576','30.16.20.10.0.0.0.00574','30.16.20.10.0.0.0.00572','30.16.20.10.0.0.0.00570','30.16.20.10.0.0.0.00568','30.16.20.10.0.0.0.00566','30.16.20.10.0.0.0.00564','30.16.20.10.0.0.0.00562','30.16.20.10.0.0.0.00560','30.16.20.10.0.0.0.00558','30.16.20.10.0.0.0.00556','30.16.20.10.0.0.0.00554','30.16.20.10.0.0.0.00552','30.16.20.10.0.0.0.00550','30.16.20.10.0.0.0.00548','30.16.20.10.0.0.0.00546','30.16.20.10.0.0.0.00544','30.16.20.10.0.0.0.00542','30.16.20.10.0.0.0.00540','30.16.20.10.0.0.0.00538','30.16.20.10.0.0.0.00536','30.16.20.10.0.0.0.00534','30.16.20.10.0.0.0.00532','30.16.20.10.0.0.0.00530','30.16.20.10.0.0.0.00528','30.16.20.10.0.0.0.00526','30.16.20.10.0.0.0.00524','30.16.20.10.0.0.0.00522','30.16.20.10.0.0.0.00520','30.16.20.10.0.0.0.00518','30.16.20.10.0.0.0.00516','30.16.20.10.0.0.0.00514','30.16.20.10.0.0.0.00512','30.16.20.10.0.0.0.00510','30.16.20.10.0.0.0.00508','30.16.20.10.0.0.0.00506','30.16.20.10.0.0.0.00504','30.16.20.10.0.0.0.00502','30.16.20.10.0.0.0.00500','30.16.20.10.0.0.0.00498','30.16.20.10.0.0.0.00494','30.16.20.10.0.0.0.00492' ))
union all
select c.firstitemid as firstitemid ,cast(cast(c.flevel as int)+1 as varchar(101)) as flevel,b.FItemID as fitemid,a.fitemid as FParentID,
cast(b.fqty as decimal(12,4) ) as fQtyPerPro,cast(round(b.fqty*c.fqty/(1-b.fscrap*0.01),4)  as decimal(12,4) )as fQty,
b.funitid as funitid,cast(b.fscrap as decimal(10,4)) as fscrap,
cast(b.fitemsize as varchar(10)) as  fitemsize,--a.Fnumber,
b.FInterID as fbominterid,a.fbomnumber,
cast(c.sn+right('000'+cast(row_number()over(order by a.finterid) as varchar(20)),3) as varchar(300)) as sn,
a.fstatus,a.fusestatus,cast(c.point+'.' as varchar(101)) as point
from icbom a join icbomchild b on a.finterid = b.finterid 
join recursive_cte c on b.fitemid = c.FParentID
where b.fitemid = c.FParentID
)
select * into #bom
from recursive_cte --option(maxrecursion 3)
order by sn;

select d.fnumber,d.fname,d.fmodel,b.fnumber as parentname,b.fname as name13,b.fmodel as model13,a.fQtyPerPro
from #bom a join t_icitem b on a.fparentid = b.fitemid 
join t_icitem c on a.fitemid = c.fitemid
join t_icitem d on a.firstitemid = d.fitemid
where b.fnumber like '13.%'
and a.fstatus = 1 and a.fusestatus = 1072
and a.firstitemid = a.fitemid