--drop table #bom;
--BOM²»ÄÜ³¬¹ý100²ã
declare @level int,@firstitem int ;
select @firstitem = 292209,@level = 0;
with recursive_cte as (
select @firstitem as firstitemid,cast(@level as varchar(101)) as flevel, a.fitemid as FParentID,b.FItemID as FItemID,cast(b.fqty  as decimal(12,4)) as fQtyPerPro,
cast(round(b.fqty/(1-b.fscrap*0.01),4)  as decimal(12,4))as fQty,a.funitid as funitid, cast(0 as decimal(10,4) ) as fscrap,
cast('' as varchar(10)) as fitemsize,--Fnumber,
a.FInterID as fbominterid,a.fbomnumber,
cast(right('000'+cast(b.fentryid as varchar(20)),3) as varchar(300))  as sn,
a.fstatus,a.fusestatus, a.froutingid,
cast ('.' as varchar(101)) as point
from icbom a join icbomchild b on a.finterid = b.finterid
where a.fitemid in (select fitemid from t_icitem where fnumber in ('13.01.06.1591','13.01.06.1588','13.01.06.1586','13.01.06.1585','13.01.06.1584','13.01.06.1582','13.01.06.1581','13.01.06.1580','13.01.06.1579','13.01.06.1577','13.01.06.1576','13.01.06.1554','13.01.06.1553','13.01.06.1552','13.01.06.1551','13.01.06.1550','13.01.06.1549','13.01.06.1548','13.01.06.1547','13.01.06.1546','13.01.06.1543','13.01.06.1542','13.01.06.1541','13.01.06.1526-HG','13.01.06.1525','13.01.06.1514-HG','13.01.06.1512-HG','13.01.06.1505-YG','13.01.06.1490-YG','13.01.06.1478-YG','13.01.06.1471-YG','13.01.06.1465-YG','13.01.06.1464-YG','13.01.06.1460-YG','13.01.06.1456-HG','13.01.06.1451-HG','13.01.06.1450-YG','13.01.06.1442-HG','13.01.06.1429-YG','13.01.06.1428-YG','13.01.06.1427-YG','13.01.06.1422-HG','13.01.06.1403-YG','13.01.06.1402-HG','13.01.06.1347-YG','13.01.06.1346-YG','13.01.06.1344-YG','13.01.06.1330-YG','13.01.06.1328-YG','13.01.06.1326-YG','13.01.06.1307-YG','13.01.06.1306-YG','13.01.06.1300-YG','13.01.06.1299-YG','13.01.06.1298-YG','13.01.06.1291-Y','13.01.06.1285A-YG','13.01.06.1283-YG','13.01.06.1281-Y','13.01.06.1279-YG','13.01.06.1277-HG','13.01.06.1275-Y','13.01.06.1273-Y','13.01.06.1272-HG','13.01.06.1270N-HG','13.01.06.1269-HG','13.01.06.1267-YG','13.01.06.1265-YG','13.01.06.1263-YG','13.01.06.1262-Y','13.01.06.1244-YG','13.01.06.1240','13.01.06.1232-YG','13.01.06.1229-YG','13.01.06.1228-YG','13.01.06.1227A-YG','13.01.06.1226-YG','13.01.06.1225-HG','13.01.06.1217-YG','13.01.06.1210-YG','13.01.06.1188-YG','13.01.06.1184-YG','13.01.06.1178-YG','13.01.06.1173-Y','13.01.06.1169-Y','13.01.06.1168-YG','13.01.06.1160-YG','13.01.06.1158-YG','13.01.06.1156-YG','13.01.06.1156-Y','13.01.06.1155-YG','13.01.06.1145-HG','13.01.06.1141-HG','13.01.06.1121-YG','13.01.06.1114-YG','13.01.06.1105-YG','13.01.06.1104-YG','13.01.06.1102-YG','13.01.06.1080-YG','13.01.06.1078-YG','13.01.06.1076-YG','13.01.06.1060-YG','13.01.06.1054-HG','13.01.06.1052-YG','13.01.06.1045-YG','13.01.06.1036-YG','13.01.06.1029-HG','13.01.06.1024-YG','13.01.06.1023-Y','13.01.06.1022-YG','13.01.06.1021-YG','13.01.06.1017-YG','13.01.06.1007-HG','13.01.06.1004-YG','13.01.06.1001-HG','13.01.06.0984-YG','13.01.06.0983-HG','13.01.06.0977A-YG','13.01.06.0976-HG','13.01.06.0974-YG','13.01.06.0974-HK','13.01.06.0973-YG','13.01.06.0968-HG','13.01.06.0968A-HG','13.01.06.0965-YG','13.01.06.0964-YG','13.01.06.0960-Y','13.01.06.0953-HG','13.01.06.0952-HG','13.01.06.0951-HG','13.01.06.0941-YG','13.01.06.0928-YG','13.01.06.0926-YG','13.01.06.0913-YG','13.01.06.0912-YG','13.01.06.0910-YG','13.01.06.0909-YG','13.01.06.0909-Y','13.01.06.0908-YG','13.01.06.0907-HG','13.01.06.0901-YG','13.01.06.0890-Y','13.01.06.0884-YG','13.01.06.0877-YG','13.01.06.0876-YG','13.01.06.0872-HG','13.01.06.0870-HG','13.01.06.0868-YG','13.01.06.0867-YG','13.01.06.0865-YG','13.01.06.0863-HG','13.01.06.0862-YG','13.01.06.0861-YG','13.01.06.0858-YG','13.01.06.0854-HG','13.01.06.0853-YG','13.01.06.0817-YG','13.01.06.0779-HG','13.01.06.0758-YG','13.01.06.0758-Y','13.01.06.0757-YG','13.01.06.0756-YG','13.01.06.0755-YG','13.01.06.0754-YG','13.01.06.0752-HG','13.01.06.0751-YG','13.01.06.0750-HG','13.01.06.0726-Y','13.01.06.0722-HG','13.01.06.0721-Y','13.01.06.0720-HG','13.01.06.0719-HG','13.01.06.0718-HG','13.01.06.0716-YG','13.01.06.0715-HG','13.01.06.0714-YG','13.01.06.0713-YG','13.01.06.0710-YG','13.01.06.0709-YG','13.01.06.0708-YG','13.01.06.0707-YG','13.01.06.0706-YG','13.01.06.0702A','13.01.06.0700-YG','13.01.06.0699-YK','13.01.06.0699-HG','13.01.06.0698-HG','13.01.06.0697-YG','13.01.06.0682-Y','13.01.06.0673-Y','13.01.06.0670-Y','13.01.06.0669-Y','13.01.06.0666-YG','13.01.06.0661-YG','13.01.06.0660-HG','13.01.06.0659-HG','13.01.06.0657-HG','13.01.06.0655-YG','13.01.06.0653-YG','13.01.06.0652-H','13.01.06.0651-YG','13.01.06.0646-YG','13.01.06.0637-YG','13.01.06.0636-YG','13.01.06.0635-YG','13.01.06.0634-YG','13.01.06.0633-YG','13.01.06.0633N-HK','13.01.06.0628-YG','13.01.06.0628A-HG','13.01.06.0625-YG','13.01.06.0625A-YG','13.01.06.0624-HG','13.01.06.0622-YG','13.01.06.0620-YG','13.01.06.0619-HG','13.01.06.0618-HG','13.01.06.0617-YG','13.01.06.0613-HG','13.01.06.0608-HG','13.01.06.0607-HG','13.01.06.0606-HG','13.01.06.0605-YG','13.01.06.0604-YG','13.01.06.0601-YG','13.01.06.0599-YG','13.01.06.0599-Y','13.01.06.0598-HG','13.01.06.0591-YG','13.01.06.0585-YG','13.01.06.0584-YG','13.01.06.0583-Y','13.01.06.0582-YG','13.01.06.0571-HG','13.01.06.0567A-HG','13.01.06.0557-HG','13.01.06.0554-YG','13.01.06.0552-HG','13.01.06.0544-YG','13.01.06.0543-YG','13.01.06.0537-H','13.01.06.0536-HG','13.01.06.0532-YG','13.01.06.0531-HG','13.01.06.0530-HG','13.01.06.0526-HG','13.01.06.0525-HG','13.01.06.0524-YG','13.01.06.0521-YG','13.01.06.0520-HG','13.01.06.0519-YG','13.01.06.0518-HG','13.01.06.0517-YG','13.01.06.0516-HG','13.01.06.0515-YG','13.01.06.0513-YG','13.01.06.0513-Y','13.01.06.0510-YG','13.01.06.0509-HG','13.01.06.0507-HG','13.01.06.0506-HG','13.01.06.0504-HG','13.01.06.0501-HG','13.01.06.0497-HG','13.01.06.0486-HG','13.01.06.0482-YG','13.01.06.0478-YG','13.01.06.0475-HG','13.01.06.0472-YG','13.01.06.0470-YG','13.01.06.0468-H','13.01.06.0467-YG','13.01.06.0466-HG','13.01.06.0464-YG','13.01.06.0461-Y','13.01.06.0460-Y','13.01.06.0458-HG','13.01.06.0453-YG','13.01.06.0452-YG','13.01.06.0451-HG','13.01.06.0450-YG','13.01.06.0448','13.01.06.0442-YG','13.01.06.0441N-HG','13.01.06.0440-YG','13.01.06.0439-YG','13.01.06.0438-HG','13.01.06.0437-YG','13.01.06.0436-YG','13.01.06.0435-HG','13.01.06.0434-YG','13.01.06.0433A-HG','13.01.06.0432N-HG','13.01.06.0428-YG','13.01.06.0427-YG','13.01.06.0426-YG','13.01.06.0425-HG','13.01.06.0423-YG','13.01.06.0422-HG','13.01.06.0420-HG','13.01.06.0418-YG','13.01.06.0417-HG','13.01.06.0416-HG','13.01.06.0414-YG','13.01.06.0413-HG','13.01.06.0412-HG','13.01.06.0407-Y','13.01.06.0404-Y','13.01.06.0403-YG','13.01.06.0401-HG','13.01.06.0399-YG','13.01.06.0395-HG','13.01.06.0394-YG','13.01.06.0392-HG','13.01.06.0391-YG','13.01.06.0390-YG','13.01.06.0387-YG','13.01.06.0384-HG','13.01.06.0371-YG','13.01.06.0370-YG','13.01.06.0368-YG','13.01.06.0367-YG','13.01.06.0357-HG','13.01.06.0356-YG','13.01.06.0352-YG','13.01.06.0347A','13.01.06.0346-HG','13.01.06.0345-YG','13.01.06.0344A-HG','13.01.06.0342-YG','13.01.06.0341-YG','13.01.06.0340-YG','13.01.06.0329-YG','13.01.06.0328-YG','13.01.06.0327-YG','13.01.06.0326-YG','13.01.06.0317-HG','13.01.06.0316-YG','13.01.06.0310-YG','13.01.06.0308-YG','13.01.06.0307-YG','13.01.06.0306-YG','13.01.06.0305-YG','13.01.06.0304-HG','13.01.06.0303-HG','13.01.06.0302-YG','13.01.06.0301-YG','13.01.06.0300-H','13.01.06.0299-YG','13.01.06.0298-YG','13.01.06.0296-H','13.01.06.0295-YG','13.01.06.0292-YG','13.01.06.0292-Y','13.01.06.0283-HG','13.01.06.0282-HG','13.01.06.0281-HG','13.01.06.0279-HG','13.01.06.0278-HG','13.01.06.0277-YG','13.01.06.0277-Y','13.01.06.0276-YG','13.01.06.0275-HG','13.01.06.0274-YG','13.01.06.0273-HG','13.01.06.0272-YG','13.01.06.0271-HG','13.01.06.0270-HG','13.01.06.0267-HG','13.01.06.0265N-HG','13.01.06.0264-HG','13.01.06.0263-YG','13.01.06.0262-HG','13.01.06.0261N-HG','13.01.06.0260-HG','13.01.06.0259-HG','13.01.06.0256-YG','13.01.06.0255-H','13.01.06.0254-YG','13.01.06.0254-Y','13.01.06.0253-HG','13.01.06.0251-HG','13.01.06.0250-HG','13.01.06.0249-HG','13.01.06.0248-YG','13.01.06.0245-YG','13.01.06.0244-HG','13.01.06.0242-HG','13.01.06.0239-HG','13.01.06.0236-HG','13.01.06.0233-YG','13.01.06.0231-YG','13.01.06.0230-YG','13.01.06.0229-YG','13.01.06.0228-YG','13.01.06.0224-HG','13.01.06.0223-HG','13.01.06.0221-HG','13.01.06.0220-YG','13.01.06.0220B-YG','13.01.06.0219-YG','13.01.06.0218-HG','13.01.06.0217-Y','13.01.06.0215-HG','13.01.06.0213-YG','13.01.06.0211-Y','13.01.06.0210B-HG','13.01.06.0206-HG','13.01.06.0206A-HG','13.01.06.0204-YG','13.01.06.0204-Y','13.01.06.0204A-Y','13.01.06.0203-YG','13.01.06.0201-YG'
))
union all
select @firstitem as firstitemid,cast(cast(c.flevel as int)+1 as varchar(101)) as flevel,a.fitemid as FParentID,b.FItemID as fitemid,
cast(b.fqty as decimal(12,4) ) as fQtyPerPro,cast(round(b.fqty*c.fqty/(1-b.fscrap*0.01),4)  as decimal(12,4) )as fQty,
b.funitid as funitid,cast(b.fscrap as decimal(10,4)) as fscrap,
cast(b.fitemsize as varchar(10)) as  fitemsize,--a.Fnumber,
a.FInterID as fbominterid,a.fbomnumber,
cast(c.sn+right('000'+cast(b.fentryid as varchar(20)),3) as varchar(300)) as sn,
a.fstatus,a.fusestatus,a.froutingid,cast(c.point+'...' as varchar(101)) as point
from icbom a join icbomchild b on a.finterid = b.finterid 
join recursive_cte c on a.fitemid = c.fitemid
where a.fitemid = c.fitemid
)
select * into #bom 
from recursive_cte order by sn--option(maxrecursion 3)-




select  a.point+a.flevel as level,a.FParentID,e.fnumber,a.FItemID,b.fnumber,b.fname ,b.fmodel,
d.fname as maketype,a.fQtyPerPro,a.fQty,c.fname as unitname,a.fscrap,
a.fitemsize,a.fstatus,a.fusestatus,a.fbominterid,a.fbomnumber,a.sn
from #bom a 
join t_icitem b on a.fitemid = b.fitemid and b.fname like '%Ë«¸´ºÏ²ã³áÆ¬%'
join t_measureunit c on a.funitid = c.fitemid
join t_submessage d on d.finterid = b.ferpclsid
join t_icitem e on a.fparentid = e.fitemid 
order by a.sn;



select e.fnumber,e.fname,e.fmodel, b.fnumber,b.fname ,b.fmodel,a.fQtyPerPro,case a.fstatus when 1 then 'ÉóºË' else 'Î´ÉóºË' end as checkstatus,
case a.fusestatus when 1073 then 'Î´Ê¹ÓÃ' else 'Ê¹ÓÃ' end as usestatus,a.fbomnumber
from #bom a 
join t_icitem b on a.fitemid = b.fitemid and b.fname like '%Ë«¸´ºÏ²ã³áÆ¬%'
join t_measureunit c on a.funitid = c.fitemid
join t_submessage d on d.finterid = b.ferpclsid
join t_icitem e on a.fparentid = e.fitemid 
order by e.fnumber ;